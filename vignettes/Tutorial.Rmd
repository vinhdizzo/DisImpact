---
title: "DisImpact Tutorial"
author: "Vinh Nguyen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DisImpact Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The `DisImpact` R package contains functions that help in determining disproportionate impact (DI) based on the following methodologies:

1. [percentage point gap](http://extranet.cccco.edu/Portals/1/TRIS/Research/Analysis/PercentagePointGapMethod2017.pdf) (PPG) method,
2. [proportionality index](http://extranet.cccco.edu/Portals/1/TRIS/Research/Accountability/GUIDELINES%20FOR%20MEASURING%20DISPROPORTIONATE%20IMPACT%20IN%20EQUITY%20PLANS.pdf) method (method #1 in reference), and
3. [80% index](http://extranet.cccco.edu/Portals/1/TRIS/Research/Accountability/GUIDELINES%20FOR%20MEASURING%20DISPROPORTIONATE%20IMPACT%20IN%20EQUITY%20PLANS.pdf) method (method #2 in reference).

## Install Package
```{r}
# From CRAN (Official)
## install.packages('DisImpact')

# From github (Development)
## devtools::install_github('vinhdizzo/DisImpact')
```

## Load Packages
```{r, message=FALSE, warning=FALSE}
library(DisImpact)
library(dplyr) # Ease in manipulations with data frames
```

## Generate Toy Data Set
To illustrate the functionality of the package, let's generate a toy data set using random numbers:
```{r}
# Data parameters
true.p <- c(0.4, 0.5, 0.3, 0.2, 0.7, 0.6)
nPerGroup <- c(100, 500, 1000, 2000, 3000, 3400)
nGroups <- length(nPerGroup); nGroups
nEachCohort <- sum(nPerGroup); nEachCohort
nCohorts <- 2

# Generate toy data
set.seed(1)
df <- data_frame(Cohort=rep(2017:2018, each=nEachCohort)
                 , Ethnicity=rep(rep(c('Native American', 'Multi-Ethnicity', 'Black', 'Hispanic', 'Asian', 'White'), times=nPerGroup), 2)
                 , Transfer=c(lapply(1:nGroups, function(i) sample(0:1, size=nPerGroup[i], replace=TRUE, prob=c(1-true.p[i], true.p[i]))) %>% unlist
                              , lapply(1:nGroups, function(i) sample(0:1, size=nPerGroup[i], replace=TRUE, prob=c(1-true.p[i]*1.05, true.p[i]*1.05))) %>% unlist
                              )
                 )
```

The toy data set can be summarized as follows:
```{r}
# Summarize toy data
dim(df)
dSumm <- df %>%
  group_by(Cohort, Ethnicity) %>%
  summarize(n=n(), Transfer_Rate=mean(Transfer))
dSumm
```

## Percentage point gap (PPG) method
`di_ppg` is the main work function, and it can take on vectors or column names the tidy way:
```{r}
# Vector
di_ppg(success=df$Transfer, group=df$Ethnicity) %>% as.data.frame
# Tidy and column reference
di_ppg(success=Transfer, group=Ethnicity, data=df) %>%
  as.data.frame
```

Sometimes, one might want to break out the DI calculation by cohort:
```{r}
# Tidy and column reference
di_ppg(success=Transfer, group=Ethnicity, cohort=Cohort, data=df) %>%
  as.data.frame
```

The user could also pass in custom reference points for comparison (eg, a state-wide rate).  `di_ppg` accepts either a single reference point to be used or a vector of reference points, one for each cohort.  For the latter, the vector of reference points will be taken to correspond to the `cohort` variable, alphabetically ordered.
```{r}
# With custom reference (single)
di_ppg(success=Transfer, group=Ethnicity, reference=0.54, data=df) %>%
  as.data.frame

# With custom reference (multiple)
## Tidy and column reference
di_ppg(success=Transfer, group=Ethnicity, cohort=Cohort, reference=c(0.5, 0.55), data=df) %>%
  as.data.frame
```

The margin of error (MOE) in `di_ppg` has 2 underlying assumptions (defaults):

1. the minimum MOE returned is 0.03, and
2. using 0.50 as the proportion in the margin of error formula, $1.96 \times \sqrt{\hat{p} (1-\hat{p}) / n}$.

To override 1, the user could specify `min_moe` in `di_ppg`.  To override 2, the user could specify `use_prop_in_moe=TRUE` in `di_ppg`.
```{r}
di_ppg(success=Transfer, group=Ethnicity, data=df, min_moe=0.02) %>%
  as.data.frame

di_ppg(success=Transfer, group=Ethnicity, data=df, min_moe=0.02, use_prop_in_moe=TRUE) %>%
  as.data.frame
```

## Proportionality index
`di_prop_index` is the main work function for this method, and it can take on vectors or column names the tidy way:

```{r}
# Without cohort
## Vector
di_prop_index(success=df$Transfer, group=df$Ethnicity) %>% as.data.frame
## Tidy and column reference
di_prop_index(success=Transfer, group=Ethnicity, data=df) %>%
  as.data.frame

# With cohort
## Vector
di_prop_index(success=df$Transfer, group=df$Ethnicity, cohort=df$Cohort) %>% as.data.frame
## Tidy and column reference
di_prop_index(success=Transfer, group=Ethnicity, cohort=Cohort, data=df) %>%
  as.data.frame
```

## 80% index
`di_80_index` is the main work function for this method, and it can take on vectors or column names the tidy way:

```{r}
# Without cohort
## Vector
di_80_index(success=df$Transfer, group=df$Ethnicity) %>% as.data.frame
## Tidy and column reference
di_80_index(success=Transfer, group=Ethnicity, data=df) %>%
  as.data.frame

# With cohort
## Vector
di_80_index(success=df$Transfer, group=df$Ethnicity, cohort=df$Cohort) %>% as.data.frame
## Tidy and column reference
di_80_index(success=Transfer, group=Ethnicity, cohort=Cohort, data=df) %>%
  as.data.frame
```

## When we have a non-success variable like drop-out
Suppose we have a variable that indicates something nevative.  We could calculate DI on the converse of it:
```{r}
di_ppg(success=!Transfer, group=Ethnicity, data=df) %>%
  as.data.frame
```

## Transformations on the fly
We can compute the success, group, and cohort variables on the fly:
```{r}
# Transform success
a <- sample(0:1, size=sum(nPerGroup)*nCohorts, replace=TRUE, prob=c(0.95, 0.05))
mean(a)
di_ppg(success=pmax(Transfer, a), group=Ethnicity, data=df) %>%
  as.data.frame

# Collapse Black and Hispanic
di_ppg(success=Transfer, group=ifelse(Ethnicity %in% c('Black', 'Hispanic'), 'Black/Hispanic', Ethnicity), data=df) %>% as.data.frame
```
